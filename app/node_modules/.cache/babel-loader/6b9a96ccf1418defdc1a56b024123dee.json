{"ast":null,"code":"import _regeneratorRuntime from\"C:/Riff-Raffle-Solana-NFT build 1-1/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Riff-Raffle-Solana-NFT build 1-1/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"C:/Riff-Raffle-Solana-NFT build 1-1/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{createContext,useCallback,useEffect,useState}from'react';import{PublicKey}from'@solana/web3.js';import{useProgramApis}from'../hooks/useProgramApis';import{fetchPrizes,fetchProceedsAccount,getRaffleProgramAccounts,toEntrantsProcessed}from'../lib/store';import{cloneDeep}from'lodash';import{areEqualObjects}from'../lib/utils';import{useConnection}from'@solana/wallet-adapter-react';import{RAFFLES_WHITELIST}from'../config/raffleWhitelist';import{jsx as _jsx}from\"react/jsx-runtime\";// @ts-ignore\nexport var RafflesStoreContext=/*#__PURE__*/createContext();var RafflesStoreProvider=function RafflesStoreProvider(_ref){var _ref$children=_ref.children,children=_ref$children===void 0?null:_ref$children;var _useConnection=useConnection(),connection=_useConnection.connection;var _useProgramApis=useProgramApis(),draffleClient=_useProgramApis.draffleClient;var _useState=useState(true),_useState2=_slicedToArray(_useState,2),fetching=_useState2[0],setFetching=_useState2[1];// prevents messy first render, but probably not optimal\nvar _useState3=useState(new Map()),_useState4=_slicedToArray(_useState3,2),raffles=_useState4[0],setRaffles=_useState4[1];var getAssociatedRaffleData=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(raffleRaw,raffleMetaData,draffleClient,connection,entrantsDataRaw){var proceedsAccount,entrants,prizes,endTimestamp;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return fetchProceedsAccount(raffleRaw.publicKey,draffleClient,connection);case 2:proceedsAccount=_context.sent;entrants=new Map();if(entrantsDataRaw){_context.next=15;break;}_context.prev=5;_context.next=8;return draffleClient.account.entrants.fetch(raffleRaw.account.entrants);case 8:entrantsDataRaw=_context.sent;_context.next=15;break;case 11:_context.prev=11;_context.t0=_context[\"catch\"](5);// TODO: Merge ended raffle data stored off-chain here\nconsole.log(\"Raffle \".concat(raffleRaw.publicKey,\" entrants account is closed\"));entrantsDataRaw={entrants:[],max:0,total:0};case 15:entrants=toEntrantsProcessed(entrantsDataRaw);_context.next=18;return fetchPrizes(raffleRaw.publicKey,draffleClient,raffleRaw.account.totalPrizes);case 18:prizes=_context.sent;endTimestamp=new Date(raffleRaw.account.endTimestamp.toNumber()*1000);return _context.abrupt(\"return\",{publicKey:raffleRaw.publicKey,metadata:raffleMetaData,endTimestamp:endTimestamp,entrantsCap:entrantsDataRaw.max,entrants:entrants,entrantsRaw:entrantsDataRaw.entrants,totalTickets:entrantsDataRaw.total,entrantsAccountAddress:raffleRaw.account.entrants,randomness:raffleRaw.account.randomness,prizes:prizes,proceeds:{address:proceedsAccount.address,ticketPrice:raffleRaw.account.ticketPrice,mint:proceedsAccount.mintInfo},isEnded:endTimestamp<new Date()});case 21:case\"end\":return _context.stop();}}},_callee,null,[[5,11]]);}));return function getAssociatedRaffleData(_x,_x2,_x3,_x4,_x5){return _ref2.apply(this,arguments);};}();var fetchAllRaffles=useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var showAll,raffleDataRawProgramAccounts,entrantsDataRawProgramAccounts,_yield$getRaffleProgr,_yield$getRaffleProgr2,newRaffles,_args3=arguments;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:showAll=_args3.length>0&&_args3[0]!==undefined?_args3[0]:false;// LOOK HERE\nsetFetching(true);raffleDataRawProgramAccounts=[];entrantsDataRawProgramAccounts=[];_context3.prev=4;_context3.next=7;return getRaffleProgramAccounts(draffleClient);case 7:_yield$getRaffleProgr=_context3.sent;_yield$getRaffleProgr2=_slicedToArray(_yield$getRaffleProgr,2);raffleDataRawProgramAccounts=_yield$getRaffleProgr2[0];entrantsDataRawProgramAccounts=_yield$getRaffleProgr2[1];_context3.next=16;break;case 13:_context3.prev=13;_context3.t0=_context3[\"catch\"](4);console.log(_context3.t0);case 16:raffleDataRawProgramAccounts=raffleDataRawProgramAccounts.filter(function(_ref4){var publicKey=_ref4.publicKey;console.log({showAll:showAll});console.log(RAFFLES_WHITELIST.has(publicKey.toBase58()));return showAll||RAFFLES_WHITELIST.has(publicKey.toBase58());});console.log({raffleDataRawProgramAccounts:raffleDataRawProgramAccounts});_context3.next=20;return Promise.all(raffleDataRawProgramAccounts.map(/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(raffleRaw){var _entrantsDataRawProgr;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:return _context2.abrupt(\"return\",getAssociatedRaffleData(raffleRaw,RAFFLES_WHITELIST.get(raffleRaw.publicKey.toString())||{name:'Unnamed Raffle',// LOOOK HERE\nalternatePurchaseMints:[]},draffleClient,connection,(_entrantsDataRawProgr=entrantsDataRawProgramAccounts.find(function(_ref6){var publicKey=_ref6.publicKey;return publicKey.equals(raffleRaw.account.entrants);}))===null||_entrantsDataRawProgr===void 0?void 0:_entrantsDataRawProgr.account));case 1:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x6){return _ref5.apply(this,arguments);};}()));case 20:newRaffles=_context3.sent.reduce(function(acc,raffle){acc.set(raffle.publicKey.toString(),raffle);return acc;},new Map());setRaffles(newRaffles);setFetching(false);case 23:case\"end\":return _context3.stop();}}},_callee3,null,[[4,13]]);})),[connection,draffleClient]);var updateRaffleById=useCallback(/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(raffleId){var updatedRaffleRaw,updatedRaffle;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!(!raffles.has(raffleId.toString())||!RAFFLES_WHITELIST.has(raffleId))){_context4.next=2;break;}return _context4.abrupt(\"return\");case 2:setFetching(true);_context4.next=5;return draffleClient.account.raffle.fetch(new PublicKey(raffleId));case 5:updatedRaffleRaw=_context4.sent;_context4.next=8;return getAssociatedRaffleData({publicKey:new PublicKey(raffleId),account:updatedRaffleRaw},RAFFLES_WHITELIST.get(raffleId),draffleClient,connection);case 8:updatedRaffle=_context4.sent;if(!areEqualObjects(raffles.get(raffleId.toString()),updatedRaffle)){setRaffles(function(currentRaffles){var newRaffles=cloneDeep(currentRaffles);newRaffles=newRaffles.set(raffleId,updatedRaffle);return newRaffles;});}setFetching(false);case 11:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x7){return _ref7.apply(this,arguments);};}(),[connection,draffleClient,raffles,setRaffles]);useEffect(function(){fetchAllRaffles();},[fetchAllRaffles]);return/*#__PURE__*/_jsx(RafflesStoreContext.Provider,{value:{raffles:raffles,fetchAllRaffles:fetchAllRaffles,updateRaffleById:updateRaffleById,fetching:fetching},children:children});};export default RafflesStoreProvider;","map":null,"metadata":{},"sourceType":"module"}