{"ast":null,"code":"import _toConsumableArray from\"C:/Riff-Raffle-Solana-NFT build 1-1/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _regeneratorRuntime from\"C:/Riff-Raffle-Solana-NFT build 1-1/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Riff-Raffle-Solana-NFT build 1-1/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"C:/Riff-Raffle-Solana-NFT build 1-1/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _objectSpread from\"C:/Riff-Raffle-Solana-NFT build 1-1/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import{useCallback,useEffect,useMemo,useState}from'react';import{CircularProgress,IconButton,MenuItem,Select,TextField,Typography}from'@material-ui/core';import{sleep}from'@project-serum/common';import{u64}from'@solana/spl-token';import toast from'react-hot-toast';import{AddBoxRounded,IndeterminateCheckBoxRounded}from'@material-ui/icons';import{MAX_NUMBER_OF_PARTICIPANTS}from'../../../../config/misc';import{buyTickets,BUY_TICKETS_TX_FEE_LAMPORTS,calculateBasketPrice}from'../../../../lib/actions/buyTickets';import{getDisplayAmount,getBuyerATABalance,getWalletLamports}from'../../../../lib/accounts';import Button from'../../../../components/Button';import useCommonStyles from'../../../../assets/styles';import{tokenInfoMap,wrappedSOL}from'../../../../config/tokenRegistry';import{useProgramApis}from'../../../../hooks/useProgramApis';import{useStyles}from'./styles';import{PublicKey}from'@solana/web3.js';import ShortenedString from'../../../../components/ShortenedString';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var MAX_TICKET_AMOUNT=1000;var isLamportsEnough=function isLamportsEnough(lamports){return(lamports!==null&&lamports!==void 0?lamports:0)>=BUY_TICKETS_TX_FEE_LAMPORTS;};export var PurchaseTickets=function PurchaseTickets(_ref){var raffle=_ref.raffle,updateRaffle=_ref.updateRaffle;var classes=_objectSpread(_objectSpread({},useCommonStyles()),useStyles());var _useProgramApis=useProgramApis(),draffleClient=_useProgramApis.draffleClient,dispenserClient=_useProgramApis.dispenserClient;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),purchaseOngoing=_useState2[0],setPurchaseOngoing=_useState2[1];var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),walletLamports=_useState4[0],setWalletLamports=_useState4[1];// const [ticketPrice, setTicketPrice] = useState<PaymentOption>({\n//   mint: raffle.proceeds.mint,\n//   price: raffle.proceeds.ticketPrice,\n//   price: raffle.proceeds.ticketPrice,\n// });\nvar nativePaymentOption=useMemo(function(){return{mint:raffle.proceeds.mint,dispenserPriceIn:new u64(1),dispenserPriceOut:new u64(1)};},[raffle]);var _useState5=useState(nativePaymentOption),_useState6=_slicedToArray(_useState5,2),paymentOption=_useState6[0],setPaymentOption=_useState6[1];var _useState7=useState({mint:raffle.proceeds.mint.publicKey,amount:undefined}),_useState8=_slicedToArray(_useState7,2),buyerATABalance=_useState8[0],setBuyerATABalance=_useState8[1];var _useState9=useState(1),_useState10=_slicedToArray(_useState9,2),ticketAmount=_useState10[0],setTicketAmount=_useState10[1];var _useState11=useState([]),_useState12=_slicedToArray(_useState11,2),dispensers=_useState12[0],setDispensers=_useState12[1];var paymentOptions=useMemo(function(){return(raffle.metadata.alternatePurchaseMints||[]).reduce(function(acc,mintAddress){if(!tokenInfoMap.has(mintAddress.toString())){console.log(\"Mint \".concat(mintAddress.toString(),\" not found in token registry\"));return acc;}var dispenser=dispensers.find(function(d){return d.account.mintTokenOut.toString()===raffle.proceeds.mint.publicKey.toString()&&d.account.mintTokenIn.toString()===mintAddress.toString();});if(!dispenser){return acc;}var tokenInfo=tokenInfoMap.get(mintAddress.toString());acc.set(mintAddress.toString(),{mint:{name:tokenInfo.name,publicKey:mintAddress,logoUrl:tokenInfo.logoURI,symbol:tokenInfo.symbol,decimals:tokenInfo.decimals},dispenserPriceIn:dispenser.account.rateTokenIn,dispenserPriceOut:dispenser.account.rateTokenOut});return acc;},new Map([[raffle.proceeds.mint.publicKey.toString(),{mint:raffle.proceeds.mint,dispenserPriceIn:new u64(1),dispenserPriceOut:new u64(1)}]]));},[raffle,dispensers]);var getBasketPrice=useCallback(function(ticketAmount){return calculateBasketPrice(raffle.proceeds.ticketPrice,ticketAmount,paymentOption);},[raffle.proceeds.ticketPrice,paymentOption]);useEffect(function(){dispenserClient.account.registry.all().then(setDispensers);},[dispenserClient,setDispensers]);useEffect(function(){var _draffleClient$provid;if(!((_draffleClient$provid=draffleClient.provider.wallet)===null||_draffleClient$provid===void 0?void 0:_draffleClient$provid.publicKey))return;var timerId;var updateLamports=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var newWalletLamports;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return getWalletLamports(draffleClient.provider);case 2:newWalletLamports=_context.sent;setWalletLamports(newWalletLamports);if(isLamportsEnough(walletLamports)&&!(paymentOption.mint.publicKey.toBase58()===wrappedSOL)){clearInterval(timerId);}case 5:case\"end\":return _context.stop();}}},_callee);}));return function updateLamports(){return _ref2.apply(this,arguments);};}();updateLamports();timerId=setInterval(function(){updateLamports();},5000);return function(){return clearInterval(timerId);};},[walletLamports,draffleClient.provider,draffleClient.provider.wallet.publicKey,paymentOption.mint.publicKey]);useEffect(function(){if(!draffleClient.provider.wallet.publicKey)return;function updateBuyerATABalance(){return _updateBuyerATABalance.apply(this,arguments);}function _updateBuyerATABalance(){_updateBuyerATABalance=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.t0=setBuyerATABalance;_context2.t1=paymentOption.mint.publicKey;_context2.next=4;return getBuyerATABalance(draffleClient.provider,paymentOption.mint.publicKey);case 4:_context2.t2=_context2.sent;_context2.t3={mint:_context2.t1,amount:_context2.t2};(0,_context2.t0)(_context2.t3);case 7:case\"end\":return _context2.stop();}}},_callee2);}));return _updateBuyerATABalance.apply(this,arguments);}var timerId=setInterval(function(){updateBuyerATABalance();},5000);updateBuyerATABalance();return function(){return clearInterval(timerId);};},[draffleClient.provider,draffleClient.provider.wallet,paymentOption.mint.publicKey]);var lamportsEnough=useMemo(function(){return isLamportsEnough(walletLamports);},[walletLamports]);var buyerTokenBalance=useMemo(function(){return paymentOption.mint.publicKey.toBase58()===wrappedSOL?{mint:new PublicKey(wrappedSOL),amount:new u64(walletLamports!==null&&walletLamports!==void 0?walletLamports:0)}// We ignore the potential wSOL ATA\n:buyerATABalance;},[walletLamports,buyerATABalance,paymentOption.mint.publicKey]);var hasEnoughFunds=useMemo(function(){var _buyerTokenBalance$am;var tokensEnough=(_buyerTokenBalance$am=buyerTokenBalance.amount)===null||_buyerTokenBalance$am===void 0?void 0:_buyerTokenBalance$am.gte(getBasketPrice(ticketAmount));return tokensEnough&&lamportsEnough;},[buyerTokenBalance,lamportsEnough,ticketAmount,getBasketPrice]);var maxTicketsToBuyable=useMemo(function(){if(!buyerTokenBalance.amount)return new u64(0);var newMax=buyerTokenBalance.amount.mul(paymentOption.dispenserPriceOut).div(paymentOption.dispenserPriceIn).div(raffle.proceeds.ticketPrice);if(paymentOption.mint.publicKey.toString()===buyerTokenBalance.mint.toString()&&newMax.ltn(ticketAmount))setTicketAmount(newMax.toNumber());return newMax;},[buyerTokenBalance,paymentOption]);useEffect(function(){var newTicketAmount=ticketAmount===0?1:ticketAmount;Math.min(ticketAmount,maxTicketsToBuyable.toNumber());setTicketAmount(newTicketAmount);},[maxTicketsToBuyable,ticketAmount,setTicketAmount]);var hasEnoughFundsToIncrementTicket=useMemo(function(){var _buyerTokenBalance$am2;var tokensEnough=(_buyerTokenBalance$am2=buyerTokenBalance.amount)===null||_buyerTokenBalance$am2===void 0?void 0:_buyerTokenBalance$am2.gte(getBasketPrice(ticketAmount+1));return tokensEnough&&lamportsEnough;},[buyerTokenBalance,lamportsEnough,ticketAmount,getBasketPrice]);var onBuyTickets=useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var buyerATAExists;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;setPurchaseOngoing(true);buyerATAExists=buyerATABalance.amount!==undefined;_context3.next=5;return buyTickets(draffleClient,dispenserClient,raffle,ticketAmount,paymentOption,buyerATAExists);case 5:setTicketAmount(1);_context3.next=8;return sleep(500);case 8:updateRaffle();toast.success(\"You bought \".concat(ticketAmount,\" ticket(s)\"));_context3.next=15;break;case 12:_context3.prev=12;_context3.t0=_context3[\"catch\"](0);if(_context3.t0.msg){toast.error(\"Transaction failed: \".concat(_context3.t0.msg));}else{toast.error('Unexpected error');}case 15:setPurchaseOngoing(false);case 16:case\"end\":return _context3.stop();}}},_callee3,null,[[0,12]]);})),[draffleClient,dispenserClient,raffle,ticketAmount,paymentOption,buyerATABalance,setTicketAmount,updateRaffle]);var onSelectPurchaseMint=function onSelectPurchaseMint(event){return setPaymentOption(paymentOptions.get(event.target.value));};return/*#__PURE__*/_jsxs(\"div\",{className:\"\".concat(classes.actionSection,\" \").concat(classes.root),children:[/*#__PURE__*/_jsx(Typography,{variant:\"h3\",className:classes.titleSection,children:\"Purchase Tickets\"}),/*#__PURE__*/_jsx(\"div\",{className:classes.amountLabel,children:/*#__PURE__*/_jsx(Typography,{variant:\"overline\",children:\"Amount\"})}),/*#__PURE__*/_jsxs(\"div\",{className:classes.ticketAmountSection,children:[/*#__PURE__*/_jsx(\"div\",{className:classes.ticketAmountSectionLeft,children:/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:function onClick(){return setTicketAmount(function(currentAmount){return Math.max(currentAmount-1,1);});},disabled:ticketAmount<=1,className:classes.changeTicketAmountButton,children:/*#__PURE__*/_jsx(IndeterminateCheckBoxRounded,{style:{fontSize:30}})})}),/*#__PURE__*/_jsx(\"div\",{className:classes.ticketAmountSectionMiddle,children:/*#__PURE__*/_jsx(TextField,{size:\"small\",variant:\"outlined\",className:classes.ticketAmountTextField,value:ticketAmount,onChange:function onChange(event){var newValue=event.target.value;var re=/^[0-9\\b]+$/;if(newValue!==''&&!re.test(newValue))return;var numericValue=Math.min(Math.min(Number(newValue),MAX_TICKET_AMOUNT-raffle.totalTickets),maxTicketsToBuyable.toNumber());setTicketAmount(numericValue);},InputProps:{endAdornment:/*#__PURE__*/_jsx(Button,{size:\"small\",variant:\"text\",disableRipple:true,className:classes.maxButton,onClick:function onClick(){var maxTickets=Math.min(MAX_TICKET_AMOUNT-raffle.totalTickets,maxTicketsToBuyable.toNumber());setTicketAmount(maxTickets);},children:\"MAX\"}),startAdornment:/*#__PURE__*/_jsx(Button,{size:\"small\",variant:\"text\",disableRipple:true,className:classes.maxButton,onClick:function onClick(){return setTicketAmount(1);},children:\"MIN\"})}})}),/*#__PURE__*/_jsx(\"div\",{className:classes.ticketAmountSectionRight,children:/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:function onClick(){return setTicketAmount(function(currentAmount){return currentAmount+1;});},disabled:raffle.totalTickets+ticketAmount>=MAX_NUMBER_OF_PARTICIPANTS||!hasEnoughFundsToIncrementTicket||ticketAmount+1>MAX_TICKET_AMOUNT-raffle.totalTickets,className:classes.changeTicketAmountButton,children:/*#__PURE__*/_jsx(AddBoxRounded,{style:{fontSize:30}})})})]}),/*#__PURE__*/_jsx(\"div\",{className:classes.priceSection,children:/*#__PURE__*/_jsxs(\"div\",{className:classes.paymentOptionSection,children:[/*#__PURE__*/_jsxs(\"div\",{className:classes.basketPrice,children:[/*#__PURE__*/_jsx(Typography,{variant:\"overline\",children:\"Total Price\"}),/*#__PURE__*/_jsx(\"div\",{style:{height:'100%',display:'flex',flexDirection:'column',alignItems:'center'},children:/*#__PURE__*/_jsx(Typography,{variant:\"h4\",children:getDisplayAmount(getBasketPrice(ticketAmount),paymentOption.mint)})})]}),/*#__PURE__*/_jsxs(\"div\",{className:classes.basketPrice,children:[/*#__PURE__*/_jsx(Typography,{variant:\"overline\",children:\"Currency\"}),paymentOptions.size===1?/*#__PURE__*/_jsxs(\"div\",{className:classes.paymentOptionSelection,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h4\",children:raffle.proceeds.mint.symbol}),/*#__PURE__*/_jsx(\"div\",{className:classes.paymentOptionLogoContainer,children:/*#__PURE__*/_jsx(\"img\",{className:classes.paymentOptionLogo,src:raffle.proceeds.mint.logoUrl,alt:\"Logo for \".concat(raffle.proceeds.mint.name)})})]}):/*#__PURE__*/_jsxs(Select,{variant:\"standard\",label:\"Purchase mint\",value:paymentOption.mint.publicKey.toString(),onChange:onSelectPurchaseMint,className:classes.paymentOptionSelect,MenuProps:{disableScrollLock:true},renderValue:function renderValue(optionKey){var option=paymentOptions.get(optionKey);return/*#__PURE__*/_jsxs(\"div\",{className:classes.paymentOptionSelection,children:[/*#__PURE__*/_jsx(Typography,{variant:\"h4\",children:option.mint.symbol}),/*#__PURE__*/_jsx(\"div\",{className:classes.paymentOptionLogoContainer,children:/*#__PURE__*/_jsx(\"img\",{className:classes.paymentOptionLogo,src:option.mint.logoUrl,alt:\"Logo for \".concat(option.mint.name)})})]});},children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",disabled:true,children:\"Select purchase currency\"}),_toConsumableArray(paymentOptions.values()).map(function(_ref4){var mint=_ref4.mint;return/*#__PURE__*/_jsxs(MenuItem,{value:mint.publicKey.toString(),classes:{root:classes.paymentOptionMenu},children:[/*#__PURE__*/_jsx(\"div\",{className:classes.paymentOptionLogoContainer,children:/*#__PURE__*/_jsx(\"img\",{className:classes.paymentOptionLogo,src:mint.logoUrl,alt:\"Logo for \".concat(mint.name)})}),/*#__PURE__*/_jsxs(Typography,{variant:\"body1\",children:[/*#__PURE__*/_jsx(ShortenedString,{message:mint.name,maxCharLength:12}),\" (\".concat(mint.symbol,\")\")]})]},mint.publicKey.toString());})]})]})]})}),/*#__PURE__*/_jsxs(\"div\",{className:classes.buySection,children:[/*#__PURE__*/_jsx(Button,{variant:\"contained\",className:classes.mainButton,onClick:onBuyTickets,disabled:ticketAmount===0||raffle.totalTickets+ticketAmount>MAX_NUMBER_OF_PARTICIPANTS||!hasEnoughFunds||purchaseOngoing,children:/*#__PURE__*/_jsx(\"div\",{className:classes.purchaseButtonContent,children:purchaseOngoing?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:classes.purchaseButtonContentLeft,children:/*#__PURE__*/_jsx(CircularProgress,{size:20,className:classes.purchaseSpinner})}),/*#__PURE__*/_jsx(\"div\",{className:classes.purchaseButtonContentMiddle,children:\"Processing...\"}),/*#__PURE__*/_jsx(\"div\",{className:classes.purchaseButtonContentRight})]}):/*#__PURE__*/_jsxs(_Fragment,{children:[\"Buy ticket \",!lamportsEnough&&'(Insufficient SOL)']})})}),/*#__PURE__*/_jsxs(\"div\",{className:classes.walletBalance,children:[\"Wallet balance:\",' ',buyerTokenBalance?getDisplayAmount(buyerTokenBalance.amount||new u64(0),paymentOption.mint):0,' ',paymentOption.mint.symbol]})]})]});};","map":null,"metadata":{},"sourceType":"module"}